<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Reforma e Ampliação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .sortable:hover {
            cursor: pointer;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Cabeçalho -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Acompanhamento de obra</h1>
            <p class="text-gray-500 mt-1">Projeto de Reforma e Ampliação da Casa</p>
        </header>

        <!-- Métricas Principais -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card flex flex-col justify-between">
                <h2 class="text-lg font-semibold text-gray-600">Custo Total do Projeto</h2>
                <p id="total-cost" class="text-4xl font-bold text-blue-600 mt-2">R$ 0,00</p>
            </div>
            <div class="card">
                <h2 class="text-lg font-semibold text-gray-600 mb-3">Prazo da Fase 1 (Reforma)</h2>
                <div class="flex justify-around text-center">
                    <div>
                        <p class="text-sm text-gray-500">Executados</p>
                        <p id="days-executed" class="text-4xl font-bold text-blue-600">--</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Restantes</p>
                        <p id="days-left" class="text-4xl font-bold text-green-600">--</p>
                    </div>
                </div>
                <p id="total-days-project" class="text-xs text-gray-400 text-center mt-3">Total: -- dias</p>
            </div>
            <div class="card flex flex-col justify-between text-sm">
                <h2 class="text-lg font-semibold text-gray-600 mb-2">Linha do Tempo</h2>
                <div class="space-y-2">
                    <p><strong>Início do Projeto:</strong> 01/10/2025</p>
                    <p><strong>Fim da Reforma:</strong> 20/12/2025</p>
                    <p><strong>Início da Ampliação:</strong> 01/01/2026</p>
                </div>
            </div>
        </div>

        <!-- Seção Principal: Gráficos e Análises -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Gráfico de Distribuição de Custos -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Distribuição de Custos</h2>
                <div class="relative h-64 md:h-80">
                     <canvas id="costs-chart"></canvas>
                </div>
            </div>
            <!-- Gráfico de Distribuição Percentual -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Distribuição Percentual</h2>
                <div class="relative h-64 md:h-80">
                     <canvas id="percentage-chart"></canvas>
                </div>
            </div>
            <!-- Lista de Custos por Categoria -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Custos por Categoria</h2>
                <div id="category-costs" class="space-y-3 h-64 md:h-80 overflow-y-auto pr-2">
                    <!-- Os custos por categoria serão inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Histórico de Lançamentos -->
        <div class="card">
             <h2 class="text-xl font-bold text-gray-800 mb-4">Histórico de Lançamentos</h2>
             <div class="overflow-x-auto">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th data-sort="date" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data <span id="sort-indicator-date"></span></th>
                            <th data-sort="description" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição <span id="sort-indicator-description"></span></th>
                            <th data-sort="category" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria <span id="sort-indicator-category"></span></th>
                            <th data-sort="amount" class="sortable px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor <span id="sort-indicator-amount"></span></th>
                        </tr>
                        <tr>
                            <th class="px-2 py-1"><input type="text" id="filter-date" placeholder="Filtrar data..." class="w-full text-sm border-gray-200 rounded-md"></th>
                            <th class="px-2 py-1"><input type="text" id="filter-description" placeholder="Filtrar descrição..." class="w-full text-sm border-gray-200 rounded-md"></th>
                            <th class="px-2 py-1"><input type="text" id="filter-category" placeholder="Filtrar categoria..." class="w-full text-sm border-gray-200 rounded-md"></th>
                            <th class="px-2 py-1"><input type="text" id="filter-amount" placeholder="Filtrar valor..." class="w-full text-sm border-gray-200 rounded-md"></th>
                        </tr>
                    </thead>
                    <tbody id="expense-list" class="bg-white divide-y divide-gray-200">
                        <tr id="no-expenses-row">
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhuma despesa encontrada.</td>
                        </tr>
                    </tbody>
                </table>
             </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels);

            const initialData = [
              { "date": "2025-10-01", "amount": 43.00, "category": "Alimentação", "description": "Almoço com Renato" },
              { "date": "2025-10-01", "amount": 13.00, "category": "Equipamento", "description": "Dois pares de luvas" },
              { "date": "2025-10-01", "amount": 20.00, "category": "Equipamento", "description": "Dez sacos de entulho" },
              { "date": "2025-10-02", "amount": 45.00, "category": "Alimentação", "description": "Almoço com Renato" },
              { "date": "2025-10-02", "amount": 36.71, "category": "Alimentação", "description": "água, copo, sabonete e papel" },
              { "date": "2025-10-02", "amount": 7.29, "category": "Equipamento", "description": "óculos de proteção" },
              { "date": "2025-10-02", "amount": 100.00, "category": "Transporte Público", "description": "recarga dos bilhetes" },
              { "date": "2025-10-02", "amount": 50.00, "category": "Combustível", "description": "gasolina do Renato" },
              { "date": "2025-10-04", "amount": 84.90, "category": "Equipamento", "description": "alicate nivelador" },
              { "date": "2025-10-04", "amount": 19.90, "category": "Equipamento", "description": "colher de pedreiro" },
              { "date": "2025-10-04", "amount": 31.90, "category": "Equipamento", "description": "desempenadeira" },
              { "date": "2025-10-04", "amount": 227.48, "category": "Materiais", "description": "Cimento, espaçadores, etc" }
            ];

            let expenses = [...initialData];
            let costsChart, percentageChart;
            let sortColumn = 'date';
            let sortDirection = 'asc';
            
            const categoryColors = {
                "Equipamento": 'rgba(255, 99, 132, 0.8)', "Alimentação": 'rgba(54, 162, 235, 0.8)',
                "Combustível": 'rgba(255, 206, 86, 0.8)', "Transporte Público": 'rgba(75, 192, 192, 0.8)',
                "Transporte por App": 'rgba(153, 102, 255, 0.8)', "Materiais": 'rgba(255, 159, 64, 0.8)',
                "Mão de Obra": 'rgba(199, 199, 199, 0.8)', "Outros": 'rgba(83, 102, 84, 0.8)'
            };

            const totalCostEl = document.getElementById('total-cost');
            const daysLeftEl = document.getElementById('days-left');
            const daysExecutedEl = document.getElementById('days-executed');
            const totalDaysProjectEl = document.getElementById('total-days-project');
            const expenseListEl = document.getElementById('expense-list');
            const categoryCostsEl = document.getElementById('category-costs');
            const noExpensesRow = document.getElementById('no-expenses-row');

            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            const formatDate = (dateString) => new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC' });

            const calculateDaysLeft = () => {
                const startDate = new Date('2025-10-01T00:00:00');
                const deadline = new Date('2025-12-20T23:59:59');
                const today = new Date();
                const msPerDay = 1000 * 60 * 60 * 24;
                const totalDays = Math.round((deadline - startDate) / msPerDay);
                let executedDays = 0;
                if (today >= startDate) executedDays = Math.round((today - startDate) / msPerDay) + 1;
                if (executedDays > totalDays) executedDays = totalDays;
                let remainingDays = 0;
                if (today < deadline) remainingDays = Math.ceil((deadline - today) / msPerDay);
                daysExecutedEl.textContent = executedDays >= 0 ? executedDays : '0';
                daysLeftEl.textContent = remainingDays >= 0 ? remainingDays : '0';
                totalDaysProjectEl.textContent = `Total: ${totalDays} dias de projeto`;
            };

            const renderCostsChart = (categoryTotals) => {
                const ctx = document.getElementById('costs-chart').getContext('2d');
                if (costsChart) costsChart.destroy();
                costsChart = new Chart(ctx, {
                    type: 'doughnut', data: { labels: Object.keys(categoryTotals), datasets: [{ data: Object.values(categoryTotals), backgroundColor: Object.keys(categoryTotals).map(label => categoryColors[label] || '#cccccc'), borderColor: '#ffffff', borderWidth: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { formatter: (value) => formatCurrency(value), color: '#fff', textShadowColor: 'black', textShadowBlur: 4, font: { weight: 'bold', size: 14 } } } }
                });
            };

            const renderPercentageChart = (categoryTotals, totalCost) => {
                const ctx = document.getElementById('percentage-chart').getContext('2d');
                if (percentageChart) percentageChart.destroy();
                percentageChart = new Chart(ctx, {
                    type: 'pie', data: { labels: Object.keys(categoryTotals), datasets: [{ data: Object.keys(categoryTotals).map(label => (categoryTotals[label] / totalCost) * 100), backgroundColor: Object.keys(categoryTotals).map(label => categoryColors[label] || '#cccccc'), borderColor: '#ffffff', borderWidth: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed.toFixed(2)}%` } }, datalabels: { formatter: (value) => `${value.toFixed(1)}%`, color: '#fff', textShadowColor: 'black', textShadowBlur: 4, font: { weight: 'bold', size: 14 } } } }
                });
            };
            
            const updateSortIndicators = () => {
                document.querySelectorAll('th[data-sort] span').forEach(span => span.textContent = '');
                const indicatorSpan = document.getElementById(`sort-indicator-${sortColumn}`);
                if (indicatorSpan) {
                    indicatorSpan.textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
                }
            };

            const updateDashboard = () => {
                const dateFilter = document.getElementById('filter-date').value.toLowerCase();
                const descriptionFilter = document.getElementById('filter-description').value.toLowerCase();
                const categoryFilter = document.getElementById('filter-category').value.toLowerCase();
                const amountFilter = document.getElementById('filter-amount').value.toLowerCase();

                const filteredExpenses = expenses.filter(exp => {
                    const formattedDate = formatDate(exp.date);
                    return formattedDate.includes(dateFilter) &&
                           exp.description.toLowerCase().includes(descriptionFilter) &&
                           exp.category.toLowerCase().includes(categoryFilter) &&
                           formatCurrency(exp.amount).toLowerCase().includes(amountFilter);
                });

                filteredExpenses.sort((a, b) => {
                    let valA = a[sortColumn];
                    let valB = b[sortColumn];

                    if (sortColumn === 'date') {
                        valA = new Date(valA);
                        valB = new Date(valB);
                    }
                    
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                
                const totalCost = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const categoryTotals = expenses.reduce((acc, exp) => {
                    acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
                    return acc;
                }, {});

                totalCostEl.textContent = formatCurrency(totalCost);
                expenseListEl.innerHTML = '';
                
                if (filteredExpenses.length === 0) {
                    expenseListEl.appendChild(noExpensesRow);
                } else {
                    filteredExpenses.forEach(exp => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(exp.date)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${exp.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${exp.category}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-medium">${formatCurrency(exp.amount)}</td>`;
                        expenseListEl.appendChild(row);
                    });
                }
                
                categoryCostsEl.innerHTML = '';
                const sortedCategories = Object.entries(categoryTotals).sort(([,a],[,b]) => b-a);
                sortedCategories.forEach(([cat, cost]) => {
                     const div = document.createElement('div');
                     div.className = 'flex justify-between items-center text-sm p-1 rounded';
                     const color = categoryColors[cat] || '#cccccc';
                     div.innerHTML = `<span class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span><span class="text-gray-700">${cat}</span></span><span class="font-semibold text-gray-800">${formatCurrency(cost)}</span>`;
                     categoryCostsEl.appendChild(div);
                });
                if (Object.keys(categoryTotals).length === 0) {
                    categoryCostsEl.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum custo por categoria.</p>';
                }

                renderCostsChart(categoryTotals);
                renderPercentageChart(categoryTotals, totalCost);
                updateSortIndicators();
            };
            
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const newSortColumn = header.dataset.sort;
                    if (sortColumn === newSortColumn) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = newSortColumn;
                        sortDirection = 'asc';
                    }
                    updateDashboard();
                });
            });

            document.querySelectorAll('#filter-date, #filter-description, #filter-category, #filter-amount').forEach(input => {
                input.addEventListener('keyup', updateDashboard);
            });
            
            calculateDaysLeft();
            updateDashboard();
            setInterval(calculateDaysLeft, 60000);
        });
    </script>
</body>
</html>

